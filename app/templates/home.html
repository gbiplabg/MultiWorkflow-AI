


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>INORBVICT AI: RAG & Flow Modes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #f3f4f6;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      width: 100%;
      max-width: 480px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.09);
      padding: 28px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    h1 {
      font-size: 24px;
      color: #2563eb;
      text-align: center;
      margin: 0;
    }
    .mode-label {
      text-align: center;
      color: #374151;
    }
    .mode-selector {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    .mode-btn {
      padding: 10px 26px;
      border-radius: 9px;
      border: none;
      background: #eef2ff;
      color: #312e81;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background .15s, color .15s;
    }
    .mode-btn.selected,
    .mode-btn:focus {
      background: #2563eb;
      color: #fff;
    }
    form {
      display: flex;
      gap: 10px;
    }
    input[type="file"],
    input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    input:focus {
      border-color: #2563eb;
    }
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #uploadBtn { background: #2563eb; color: #fff; }
    #sendBtn { background: #16a34a; color: #fff; }
    #clearChat { margin-top: 12px; background: #ef4444; color: #fff; width: 100%; }
    #uploadStatus {
      font-size: 0.97rem;
      min-height: 20px;
      margin: 7px 0 0 4px;
    }
    .success { color: #16a34a; }
    .error { color: #dc2626; }
    .info { color: #2563eb; }
    #chatBox {
      min-height: 220px;
      max-height: 340px;
      overflow-y: auto;
      border: 1.5px solid #e5e7eb;
      padding: 20px 16px;
      border-radius: 13px;
      background: #f8fafc;
      margin-bottom: 6px;
      font-size: 1rem;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .empty-chat { color: #94a3b8; text-align: center; }
    .chat-row { display: flex; width: 100%; }
    .chat-row.right { justify-content: flex-end; }
    .chat-row.left { justify-content: flex-start; }
    .message {
      display: inline-block;
      padding: 9px 13px;
      border-radius: 13px;
      max-width: 80%;
      word-break: break-word;
      font-size: 1rem;
      margin-bottom: 2px;
    }
    .user-msg { background: #bbf7d0; align-self: flex-end; }
    .bot-msg { background: #e0e7ff; align-self: flex-start; }
    .typing { color: #64748b; font-style: italic; }
    @media (max-width:600px) {
      .container { max-width: 96vw; padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“„INORBVICT AI</h1>
    <div class="mode-label">Choose Chat Mode:</div>
    <div class="mode-selector">
      <button class="mode-btn selected" id="ragBtn">RAG</button>
      <button class="mode-btn" id="flowBtn">Flow</button>
    </div>

    <!-- PDF Upload Section -->
    <div id="ragSection">
      <form id="uploadForm">
        <input type="file" id="fileInput" name="file" accept=".pdf" />
        <button type="submit" id="uploadBtn">Upload</button>
      </form>
      <div id="uploadStatus" aria-live="polite"></div>
    </div>

    <!-- Chat Section -->
    <div id="chatBox"><div class="empty-chat">Select mode, upload PDF (for RAG), and start chatting!</div></div>
    <form id="chatForm" autocomplete="off">
      <input type="text" id="queryInput" placeholder="Type your message..." autocomplete="off" />
      <button type="submit" id="sendBtn">Send</button>
    </form>
    <button id="clearChat">Clear Chat</button>
  </div>

  <script>
    const ragBtn = document.getElementById("ragBtn");
    const flowBtn = document.getElementById("flowBtn");
    const ragSection = document.getElementById("ragSection");
    const uploadForm = document.getElementById("uploadForm");
    const chatForm = document.getElementById("chatForm");
    const chatBox = document.getElementById("chatBox");
    const queryInput = document.getElementById("queryInput");
    const uploadStatus = document.getElementById("uploadStatus");
    const clearChat = document.getElementById("clearChat");
    const uploadBtn = document.getElementById("uploadBtn");

    let mode = "rag";
    let chatHistories = { rag: [], flow: [] };
    let pdfUploaded = false;
    let statusTimeout = null;

    function setMode(m) {
      mode = m;
      ragBtn.classList.toggle("selected", m === "rag");
      flowBtn.classList.toggle("selected", m === "flow");
      ragSection.style.display = m === "rag" ? "block" : "none";
      renderChat();
      queryInput.value = "";
      queryInput.focus();
    }

    ragBtn.onclick = () => setMode("rag");
    flowBtn.onclick = () => setMode("flow");

    function renderChat() {
      chatBox.innerHTML = "";
      const history = chatHistories[mode];
      if (history.length === 0) {
        const msg = mode === "rag"
          ? (pdfUploaded ? "Chat history cleared." : "Select mode, upload PDF, and start chatting!")
          : "Chat history cleared. Start chatting in Flow mode!";
        chatBox.innerHTML = `<div class="empty-chat">${msg}</div>`;
      } else {
        history.forEach(m => appendMessage(m.text, m.type, false));
      }
    }

    function appendMessage(text, type = "bot", save = true) {
      const row = document.createElement("div");
      row.className = `chat-row ${type === "user" ? "right" : "left"}`;
      const msg = document.createElement("div");
      msg.className = `message ${type === "user" ? "user-msg" : "bot-msg"}`;
      msg.innerText = text;
      row.appendChild(msg);
      chatBox.appendChild(row);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
      if (save) chatHistories[mode].push({ text, type });
    }

    function setStatus(message, type = "info", autoClear = false) {
      if (statusTimeout) clearTimeout(statusTimeout);
      uploadStatus.className = type;
      uploadStatus.textContent = message;
      if (autoClear) {
        statusTimeout = setTimeout(() => { uploadStatus.textContent = ""; }, 2000);
      }
    }

    uploadForm.onsubmit = async e => {
      e.preventDefault();
      const file = document.getElementById("fileInput").files[0];
      if (!file) { setStatus("Please select a PDF.", "error"); return; }
      if (file.type !== "application/pdf") { setStatus("Only PDF files allowed.", "error"); return; }

      uploadBtn.disabled = true;
      setStatus("Uploading document...", "info");
      try {
        const res = await fetch("/upload_pdf/", { method: "POST", body: new FormData(uploadForm) });
        if (!res.ok) throw new Error("Server error");
        const data = await res.json();
        pdfUploaded = true;
        setStatus(data.message || "Upload successful!", "success", true);
        renderChat();
        queryInput.focus();
      } catch (err) {
        setStatus("âŒ Upload failed. Try again.", "error", true);
      } finally {
        uploadBtn.disabled = false;
      }
    };

    chatForm.onsubmit = async e => {
      e.preventDefault();
      if (mode === "rag" && !pdfUploaded) { setStatus("Upload a PDF first!", "error"); return; }
      const query = queryInput.value.trim();
      if (!query) { queryInput.focus(); return; }

      appendMessage(query, "user");
      queryInput.value = ""; // Clear input after sending
      queryInput.focus();

      const typing = document.createElement("div");
      typing.className = "typing";
      typing.textContent = "Assistant is typing...";
      chatBox.appendChild(typing);
      chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });

      try {
        let url, body, headers;
        if (mode === "rag") {
          url = "/chat/";
          body = new URLSearchParams({ query });
          headers = {};
        } else {
          url = "/chat/flow";
          body = JSON.stringify({ user_message: query });
          headers = { "Content-Type": "application/json" };
        }
        const res = await fetch(url, { method: "POST", body, headers });
        typing.remove();
        const data = await res.json();
        const reply = mode === "rag"
          ? (data.response || data.error || "No response.")
          : (data.bot_messages || data.error || "No response.");
        appendMessage(reply, "bot");
      } catch (err) {
        typing.remove();
        appendMessage("Error: Unable to fetch response.", "bot");
      }
    };

    clearChat.onclick = () => { chatHistories[mode] = []; renderChat(); }

    queryInput.onkeydown = e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    };

    // Initialize
    setMode("rag");
  </script>
</body>
</html>

